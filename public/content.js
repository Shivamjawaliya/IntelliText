/*! For license information please see content.js.LICENSE.txt */
(()=>{"use strict";var e="AIzaSyCeQKq5Uu49gaO-7gp3zXdoVsVs8ZjJ2tA";function t(){var e,n,r="function"==typeof Symbol?Symbol:{},c=r.iterator||"@@iterator",a=r.toStringTag||"@@toStringTag";function i(t,r,c,a){var i=r&&r.prototype instanceof l?r:l,u=Object.create(i.prototype);return o(u,"_invoke",function(t,o,r){var c,a,i,l=0,u=r||[],d=!1,p={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(t,o){return c=t,a=0,i=e,p.n=o,s}};function g(t,o){for(a=t,i=o,n=0;!d&&l&&!r&&n<u.length;n++){var r,c=u[n],g=p.p,m=c[2];t>3?(r=m===o)&&(i=c[(a=c[4])?5:(a=3,3)],c[4]=c[5]=e):c[0]<=g&&((r=t<2&&g<c[1])?(a=0,p.v=o,p.n=c[1]):g<m&&(r=t<3||c[0]>o||o>m)&&(c[4]=t,c[5]=o,p.n=m,a=0))}if(r||t>1)return s;throw d=!0,o}return function(r,u,m){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&g(u,m),a=u,i=m;(n=a<2?e:i)||!d;){c||(a?a<3?(a>1&&(p.n=-1),g(a,i)):p.n=i:p.v=i);try{if(l=2,c){if(a||(r="next"),n=c[r]){if(!(n=n.call(c,i)))throw TypeError("iterator result is not an object");if(!n.done)return n;i=n.value,a<2&&(a=0)}else 1===a&&(n=c.return)&&n.call(c),a<2&&(i=TypeError("The iterator does not provide a '"+r+"' method"),a=1);c=e}else if((n=(d=p.n<0)?i:t.call(o,p))!==s)break}catch(t){c=e,a=1,i=t}finally{l=1}}return{value:n,done:d}}}(t,c,a),!0),u}var s={};function l(){}function u(){}function d(){}n=Object.getPrototypeOf;var p=[][c]?n(n([][c]())):(o(n={},c,(function(){return this})),n),g=d.prototype=l.prototype=Object.create(p);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,o(e,a,"GeneratorFunction")),e.prototype=Object.create(g),e}return u.prototype=d,o(g,"constructor",d),o(d,"constructor",u),u.displayName="GeneratorFunction",o(d,a,"GeneratorFunction"),o(g),o(g,a,"Generator"),o(g,c,(function(){return this})),o(g,"toString",(function(){return"[object Generator]"})),(t=function(){return{w:i,m}})()}function o(e,t,n,r){var c=Object.defineProperty;try{c({},"",{})}catch(e){c=0}o=function(e,t,n,r){if(t)c?c(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n;else{var a=function(t,n){o(e,t,(function(e){return this._invoke(t,n,e)}))};a("next",0),a("throw",1),a("return",2)}},o(e,t,n,r)}function n(e,t,o,n,r,c,a){try{var i=e[c](a),s=i.value}catch(e){return void o(e)}i.done?t(s):Promise.resolve(s).then(n,r)}function r(e){return function(){var t=this,o=arguments;return new Promise((function(r,c){var a=e.apply(t,o);function i(e){n(a,r,c,i,s,"next",e)}function s(e){n(a,r,c,i,s,"throw",e)}i(void 0)}))}}var c=null,a=null,i="",s=!1,l=!1,u=null,d=null,p="",g="";function m(e){var t=e.tagName,o=e.isContentEditable,n=e.getAttribute("role");return"INPUT"===t&&!["button","submit","reset","checkbox","radio","file","image"].includes(e.type)||"TEXTAREA"===t||(o?"main"!==e.id&&"search"!==e.getAttribute("data-tab"):"DIV"===t&&"textbox"===n&&"10"===e.getAttribute("data-tab"))}console.log("%c🔍 Gemini Text Enhancer content script loaded!","background: #4CAF50; color: white; padding: 5px; border-radius: 3px; font-size: 14px;");var f=document.createElement("div");f.style.cssText="\n    position: fixed;\n    bottom: 10px;\n    right: 10px;\n    background: #4CAF50;\n    color: white;\n    padding: 5px 10px;\n    border-radius: 3px;\n    font-size: 12px;\n    z-index: 999999;\n    opacity: 0.8;\n",f.textContent="Gemini Enhancer Active",document.body.appendChild(f);var v=function(e){if(console.log("%c🔍 getInputText called for:","color: #2196F3",e),!e)return console.error("%cgetInputText received null/undefined element.","color: #F44336"),"";if("INPUT"===e.tagName||"TEXTAREA"===e.tagName)return console.log("%cInput/Textarea value:","color: #2196F3",e.value),e.value;var t=function(e){for(var t=e;t;){if(t.isContentEditable)return t;t=t.parentElement}return null}(e);if(t){console.log("%cContentEditable element found:","color: #2196F3",t);var o=t.querySelector('.selectable-text.copyable-text[data-lexical-text="true"]');return o?(console.log("%cText span content:","color: #2196F3",o.textContent),o.textContent):(console.log("%cContentEditable textContent:","color: #2196F3",t.textContent),t.textContent)}return console.log("%cNo text found for element.","color: #F44336"),""};function b(e,t){return h.apply(this,arguments)}function h(){return(h=r(t().m((function e(o,n){var r,c,a,s,d,p,g;return t().w((function(e){for(;;)switch(e.n){case 0:if(console.log("%c✍️ Setting text for element:","color: #2196F3",o,"with text:",n),o){e.n=1;break}return console.log("No element provided to setInputText"),e.a(2);case 1:if(r="true"===o.getAttribute("contenteditable"),c="TEXTAREA"===o.tagName,a="INPUT"===o.tagName,s=window.location.hostname.includes("web.whatsapp.com"),console.log("Element type:",{isContentEditable:r,isTextarea:c,isInput:a,isWhatsApp:s,tagName:o.tagName}),!r){e.n=8;break}if(d=o,(p=u&&u.isConnected)&&(console.log("Disconnecting observer before setting text"),u.disconnect()),l=!0,console.log("%c🚩 isApiUpdate set to TRUE in setInputText (before DOM mod).","color: #FFC107","Time: ".concat(performance.now().toFixed(2),"ms")),e.p=2,!s){e.n=4;break}return e.n=3,setEditableText(d,n);case 3:e.n=5;break;case 4:d.textContent=n,d.dispatchEvent(new Event("input",{bubbles:!0}));case 5:setTimeout((function(){l=!1,console.log("%c🚩 isApiUpdate set to FALSE (after delay).","color: #FFC107","Time: ".concat(performance.now().toFixed(2),"ms")),i=n,console.log("%c[MutationObserver] lastProcessedText reset to:","color: #FFC107",'"'.concat(i,'"'))}),300),d&&p&&(console.log("Reconnecting observer after setting text"),x(d)),e.n=7;break;case 6:e.p=6,g=e.v,console.error("Error setting contenteditable text:",g),l=!1;case 7:e.n=9;break;case 8:if(c||a){l=!0,console.log("%c🚩 isApiUpdate set to TRUE in setInputText (before DOM mod).","color: #FFC107","Time: ".concat(performance.now().toFixed(2),"ms"));try{o.value=n,o.dispatchEvent(new Event("input",{bubbles:!0})),setTimeout((function(){l=!1,console.log("%c🚩 isApiUpdate set to FALSE (after delay).","color: #FFC107","Time: ".concat(performance.now().toFixed(2),"ms")),i=n,console.log("%c[MutationObserver] lastProcessedText reset to:","color: #FFC107",'"'.concat(i,'"'))}),300)}catch(e){console.error("Error setting input/textarea value:",e),l=!1}}else console.log("Element is not a valid input type:",o.tagName);case 9:return e.a(2)}}),e,null,[[2,6]])})))).apply(this,arguments)}var x=function(e){u&&(u.disconnect(),console.log("%cDisconnecting previous MutationObserver.","color: #FFC107")),console.log("%cSetting up MutationObserver for contenteditable element:","color: #FFC107",e),(u=new MutationObserver((function(t){if(l)console.log("%cSkipping mutation processing during API update.","color: #FFC107");else{console.log("%c🌳 MutationObserver callback triggered.","color: #4CAF50","Time: ".concat(performance.now().toFixed(2),"ms"));var o=v(e),n=o.trim(),r=i.trim(),c=p.trim();console.log("%c[MutationObserver] Current text (trimmed): ","color: #4CAF50",'"'.concat(n,'"')),console.log("%c[MutationObserver] Last processed text (trimmed): ","color: #4CAF50",'"'.concat(r,'"')),console.log("%c[MutationObserver] Last enhanced text (trimmed): ","color: #4CAF50",'"'.concat(c,'"')),console.log("%c[MutationObserver] current === lastEnhanced: ","color: #4CAF50",n===c),console.log("%c[MutationObserver] current === lastProcessed: ","color: #4CAF50",n===r),n!==c&&n!==r?(n!==r&&n&&(console.log("%c[MutationObserver] Text changed and is not empty/whitespace, scheduling new timeout for popup (2000ms).","color: #4CAF50"),d&&clearTimeout(d),d=setTimeout((function(){console.log("%c[MutationObserver] Timeout triggered! Attempting to show popup.","color: #4CAF50");var t=v(e),o=t.trim();o&&o!==c?(console.log("%c[MutationObserver] Text is genuinely new after delay, showing popup.","color: #4CAF50"),T(e,t)):console.log("%c[MutationObserver] Text is empty, whitespace, or matches last enhanced text at timeout, not showing popup.","color: #FFC107")}),2e3),i=o,console.log("%c[MutationObserver] lastProcessedText updated to:","color: #FFC107",'"'.concat(i,'"'))),console.log("%cisApiUpdate after mutation processing:","color: #FFC107",l)):console.log("Text matches last enhanced/processed text, not showing popup.")}}))).observe(e,{childList:!0,subtree:!0,characterData:!0})},T=function(e,t){if(!e||!e.offsetParent)return console.log("%cElement not visible or invalid for popup.","color: #FFC107"),void E();g=t,console.log("%cText stored for enhancement:","color: #4CAF50",'"'.concat(g,'"'),"Time: ".concat(performance.now().toFixed(2),"ms"));var o=e.getBoundingClientRect(),n=o.left+window.scrollX,r=o.bottom+window.scrollY+5;n+200>window.innerWidth&&(n=window.innerWidth-200-10),r+50>window.innerHeight&&(r=o.top+window.scrollY-50-5),w.style.left="".concat(n,"px"),w.style.top="".concat(r,"px"),w.style.display="block",w.offsetHeight,w.style.opacity="1",console.log("Popup shown for:",e.tagName,"at","(".concat(n,", ").concat(r,")"),"Time: ".concat(performance.now().toFixed(2),"ms"))},F=function(){var o=r(t().m((function o(n){var r,c,a,i,s,l,u=arguments;return t().w((function(t){for(;;)switch(t.n){case 0:if(r=u.length>1&&void 0!==u[1]&&u[1],e){t.n=1;break}return console.error("Gemini API key is not set."),r||alert("Gemini API key is not set. Please check your config.js"),t.a(2,null);case 1:return c="Fix any grammatical errors and improve this text to be more professional, but keep it concise and only give option one: ".concat(n),t.p=2,t.n=3,C(c,r);case 3:if(!((a=t.v)&&a.candidates&&a.candidates.length>0)){t.n=4;break}return i=a.candidates[0].content.parts[0].text,s=i.match(/Option 1:\s*(.*)/i),t.a(2,s?s[1].trim():i.trim());case 4:return console.warn("Gemini API response did not contain candidates.",a),r||alert("Could not get enhanced text from Gemini API. No candidates found."),t.a(2,null);case 5:t.n=7;break;case 6:return t.p=6,l=t.v,console.error("Error enhancing text with Gemini API:",l),r||alert("Error enhancing text: ".concat(l.message,". Check console for details.")),t.a(2,null);case 7:return t.a(2)}}),o,null,[[2,6]])})));return function(e){return o.apply(this,arguments)}}();function y(e){if("TEXTAREA"===e.tagName||"INPUT"===e.tagName)e.focus(),e.setSelectionRange(e.value.length,e.value.length);else if(e.isContentEditable){var t=document.createRange(),o=window.getSelection();t.selectNodeContents(e),t.collapse(!1),o.removeAllRanges(),o.addRange(t)}}var w=function(){var e=document.createElement("div");return e.id="gemini-enhancer-popup",e.style.cssText="\n        position: absolute;\n    ",document.body.appendChild(e),e}();function E(){w.innerHTML="<button>Enhance</button>",w.style.opacity="0",w.style.display="none",c&&(clearTimeout(c),c=null),d&&(clearTimeout(d),d=null)}function C(e){return A.apply(this,arguments)}function A(){return A=r(t().m((function o(n){var r,c,a,i,s,l,u=arguments;return t().w((function(t){for(;;)switch(t.n){case 0:return r=u.length>1&&void 0!==u[1]&&u[1],c={contents:[{parts:[{text:n}]}]},t.p=1,t.n=2,fetch("".concat("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","?key=").concat(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});case 2:if(a=t.v,console.log("API Response Status:",a.status),console.log("API Response Status Text:",a.statusText),a.ok){t.n=4;break}return t.n=3,a.json();case 3:throw i=t.v,console.error("API Error Response:",i),new Error("API request failed: ".concat(a.status,"  - ").concat(i.error.message));case 4:return t.n=5,a.json();case 5:return s=t.v,t.a(2,s);case 6:throw t.p=6,l=t.v,console.error("%c❌ Error calling Gemini API:","color: #F44336",l),r||alert("Error calling Gemini API: ".concat(l.message,". Check console for details.")),l;case 7:return t.a(2)}}),o,null,[[1,6]])}))),A.apply(this,arguments)}document.addEventListener("focusin",(function(e){var t,o,n=e.target;if(m(n))a=n,console.log("Focus event detected on element:",n.tagName,", contentEditable:",n.isContentEditable),console.log("Setting lastActiveInput to:",a),c&&(clearTimeout(c),c=null),w.style.display="none",E(),x(n),i=v(n);else{if((o=(null===(t=n.getAttribute("aria-label"))||void 0===t?void 0:t.toLowerCase())||"").includes("search")||o.includes("search input"))return void console.log("Ignoring search box focus");console.log("Focus event detected on element (ignored as not valid input): ",n.tagName,", contentEditable:",n.isContentEditable)}})),document.addEventListener("input",(function(e){if(console.log("%c⌨️ Input event detected:","color: #FF9800",e.target.tagName,"Time: ".concat(performance.now().toFixed(2),"ms")),l)console.log("%cInput event is from API update, not showing popup.","color: #FFC107");else{var t=e.target;if(t&&m(t)){var o=v(t),n=o.trim(),r=i.trim(),s=p.trim();console.log("Current text from getInputText:",'"'.concat(o,'"')),console.log("Current text (trimmed): ",'"'.concat(n,'"')),console.log("Last processed text (trimmed): ",'"'.concat(r,'"')),console.log("Last enhanced text (trimmed): ",'"'.concat(s,'"')),console.log("current === lastEnhanced: ",n===s),console.log("current === lastProcessed: ",n===r),n!==s&&n!==r?n!==r&&(console.log("Text changed from last processed, scheduling popup timer."),c&&clearTimeout(c),c=setTimeout((function(){a&&a===t&&(console.log("Timeout triggered! Showing popup for element:",t,"Time: ".concat(performance.now().toFixed(2),"ms")),T(t,o))}),2e3),i=o,console.log("%clastProcessedText updated to:","color: #FFC107",'"'.concat(i,'"'))):console.log("Text matches last enhanced/processed text, not showing popup.")}}})),w.addEventListener("click",function(){var e=r(t().m((function e(o){var n,r;return t().w((function(e){for(;;)switch(e.n){case 0:if(o.stopPropagation(),!s){e.n=1;break}return e.a(2);case 1:if(a&&m(a)){e.n=2;break}return w.style.display="none",E(),alert("Please click on an input field and type some text first"),console.error("No valid lastActiveInput when enhance button clicked. lastActiveInput:",a),e.a(2);case 2:if(g.trim()){e.n=3;break}return w.style.display="none",E(),alert("No text available to enhance."),console.error("Attempted to enhance empty text from textToEnhance."),e.a(2);case 3:return e.p=3,s=!0,w.innerHTML="....",console.log("%c🤖 Calling Gemini API with stored textToEnhance:","color: #8D6E63",'"'.concat(g,'"'),"Time: ".concat(performance.now().toFixed(2),"ms")),e.n=4,F(g,!0);case 4:if(!(n=e.v)){e.n=6;break}return l=!0,console.log("%c🚩 isApiUpdate set to TRUE in popup click handler (before setInputText).","color: #FFC107","Time: ".concat(performance.now().toFixed(2),"ms")),e.n=5,b(a,n);case 5:y(a),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),p=n,console.log("%clastEnhancedText updated to:","color: #FFC107",'"'.concat(p,'"'),"Time: ".concat(performance.now().toFixed(2),"ms")),w.style.display="none",E(),e.n=7;break;case 6:w.innerHTML="Error: Could not enhance text",setTimeout(E,2e3);case 7:e.n=9;break;case 8:e.p=8,r=e.v,console.error("Error during text enhancement:",r),w.innerHTML="Error: "+r.message,setTimeout(E,2e3);case 9:return e.p=9,s=!1,u&&(u.disconnect(),u=null),e.f(9);case 10:return e.a(2)}}),e,null,[[3,8,9,10]])})));return function(t){return e.apply(this,arguments)}}())})();