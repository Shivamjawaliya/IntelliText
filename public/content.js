/*! For license information please see content.js.LICENSE.txt */
(()=>{"use strict";var e,t="AIzaSyDuZX7vBe47JshbLblQYzJ-w-ZOJiu8v6A";function n(){var e,t,r="function"==typeof Symbol?Symbol:{},c=r.iterator||"@@iterator",a=r.toStringTag||"@@toStringTag";function i(n,r,c,a){var i=r&&r.prototype instanceof s?r:s,u=Object.create(i.prototype);return o(u,"_invoke",function(n,o,r){var c,a,i,s=0,u=r||[],d=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(t,n){return c=t,a=0,i=e,p.n=n,l}};function f(n,o){for(a=n,i=o,t=0;!d&&s&&!r&&t<u.length;t++){var r,c=u[t],f=p.p,m=c[2];n>3?(r=m===o)&&(i=c[(a=c[4])?5:(a=3,3)],c[4]=c[5]=e):c[0]<=f&&((r=n<2&&f<c[1])?(a=0,p.v=o,p.n=c[1]):f<m&&(r=n<3||c[0]>o||o>m)&&(c[4]=n,c[5]=o,p.n=m,a=0))}if(r||n>1)return l;throw d=!0,o}return function(r,u,m){if(s>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,m),a=u,i=m;(t=a<2?e:i)||!d;){c||(a?a<3?(a>1&&(p.n=-1),f(a,i)):p.n=i:p.v=i);try{if(s=2,c){if(a||(r="next"),t=c[r]){if(!(t=t.call(c,i)))throw TypeError("iterator result is not an object");if(!t.done)return t;i=t.value,a<2&&(a=0)}else 1===a&&(t=c.return)&&t.call(c),a<2&&(i=TypeError("The iterator does not provide a '"+r+"' method"),a=1);c=e}else if((t=(d=p.n<0)?i:n.call(o,p))!==l)break}catch(t){c=e,a=1,i=t}finally{s=1}}return{value:t,done:d}}}(n,c,a),!0),u}var l={};function s(){}function u(){}function d(){}t=Object.getPrototypeOf;var p=[][c]?t(t([][c]())):(o(t={},c,(function(){return this})),t),f=d.prototype=s.prototype=Object.create(p);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,o(e,a,"GeneratorFunction")),e.prototype=Object.create(f),e}return u.prototype=d,o(f,"constructor",d),o(d,"constructor",u),u.displayName="GeneratorFunction",o(d,a,"GeneratorFunction"),o(f),o(f,a,"Generator"),o(f,c,(function(){return this})),o(f,"toString",(function(){return"[object Generator]"})),(n=function(){return{w:i,m}})()}function o(e,t,n,r){var c=Object.defineProperty;try{c({},"",{})}catch(e){c=0}o=function(e,t,n,r){if(t)c?c(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n;else{var a=function(t,n){o(e,t,(function(e){return this._invoke(t,n,e)}))};a("next",0),a("throw",1),a("return",2)}},o(e,t,n,r)}function r(e,t,n,o,r,c,a){try{var i=e[c](a),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(o,r)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(o,c){var a=e.apply(t,n);function i(e){r(a,o,c,i,l,"next",e)}function l(e){r(a,o,c,i,l,"throw",e)}i(void 0)}))}}function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function i(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,a=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){i=!0,c=e},f:function(){try{a||null==n.return||n.return()}finally{if(i)throw c}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}var s=null,u=null,d="",p=!1,f=null,m=null,g="",h="",v="\n\nConstraints: Respond with exactly one final rewrite/translation only. Do not include multiple options, bullets, quotes, examples, or explanations. Do not repeat or include the original/source text. Output only the final rewritten/translated sentence.";function b(e){if(console.log("🔧 Step 2 - Looking for Lexical editor..."),!e)return null;for(var t=["__lexicalEditor","_lexicalEditor","lexicalEditor","_editor","__editor","editor"],n=e;n;){var o,r=i(t);try{for(r.s();!(o=r.n()).done;){var c=o.value;try{if(n[c]&&"object"===a(n[c]))return console.log("🔧 Step 2 - Found editor via property: ".concat(c)),n[c]}catch(e){}}}catch(e){r.e(e)}finally{r.f()}n=n.parentElement}try{var l,s=i(Object.getOwnPropertyNames(window));try{for(s.s();!(l=s.n()).done;){var u=l.value;if(u)try{var d=window[u];if(d&&"object"===a(d)&&"function"==typeof d.update){var p=String(u).toLowerCase();if(p.includes("lexical")||p.includes("editor"))return console.log("🔧 Step 2 - Found editor on window: ".concat(u)),d}}catch(e){}}}catch(e){s.e(e)}finally{s.f()}}catch(e){}return console.log("🔧 Step 2 - No Lexical editor instance found."),null}function y(e,t){return x.apply(this,arguments)}function x(){return(x=c(n().m((function e(t,o){var r,c,a;return n().w((function(e){for(;;)switch(e.n){case 0:if(t&&"function"==typeof t.update){e.n=1;break}return console.log("🔧 No usable editor.update() found on instance."),e.a(2,!1);case 1:if("function"!=typeof window.$getRoot||"function"!=typeof window.$createParagraphNode||"function"!=typeof window.$createTextNode){e.n=4;break}return e.p=2,console.log("🔧 Step 3 - Using page-exposed Lexical helpers to update editor state."),t.update((function(){var e=window.$getRoot();e.clear();var t=window.$createParagraphNode();t.append(window.$createTextNode(o)),e.append(t)})),e.a(2,!0);case 3:e.p=3,c=e.v,console.error("🔧 Lexical helper path failed:",c);case 4:return e.p=4,console.log("🔧 Step 3 - Attempting generic editor.update insertion..."),r=!1,t.update((function(){try{if("function"==typeof t.insertText)return t.insertText(o),void(r=!0);if("function"==typeof t.getRootElement){var e=t.getRootElement();if(e&&e.nodeType===Node.ELEMENT_NODE){for(;e.firstChild;)e.removeChild(e.firstChild);var n=document.createElement("p");return n.textContent=o,e.appendChild(n),void(r=!0)}}throw new Error("No safe insertion method found in generic editor.update()")}catch(e){throw console.warn("🔧 inside lexicalEditor.update: fallback hit",e),e}})),e.a(2,!!r);case 5:return e.p=5,a=e.v,console.warn("🔧 Generic lexicalEditor.update path failed:",a),e.a(2,!1)}}),e,null,[[4,5],[2,3]])})))).apply(this,arguments)}var w="";function E(){return C.apply(this,arguments)}function C(){return(C=c(n().m((function e(){var t,o;return n().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,null===(t=chrome)||void 0===t||null===(t=t.storage)||void 0===t||!t.sync){e.n=1;break}return e.a(2,new Promise((function(e){chrome.storage.sync.get({savedPrompt:""},(function(t){if(chrome.runtime.lastError)console.error("Error loading saved prompt:",chrome.runtime.lastError),e("");else{var n="string"==typeof(null==t?void 0:t.savedPrompt)?t.savedPrompt:"";w=n,window.__lastPopupPrompt=n,console.log("[content.js] Loaded savedPrompt from storage:",n),e(n)}}))})));case 1:e.n=3;break;case 2:e.p=2,o=e.v,console.error("Error accessing Chrome storage:",o);case 3:return e.a(2,"")}}),e,null,[[0,2]])})))).apply(this,arguments)}function F(e){return T.apply(this,arguments)}function T(){return(T=c(n().m((function e(t){var o,r;return n().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,null===(o=chrome)||void 0===o||null===(o=o.storage)||void 0===o||!o.sync){e.n=1;break}return e.a(2,new Promise((function(e){chrome.storage.sync.set({savedPrompt:t},(function(){chrome.runtime.lastError?(console.error("Error saving prompt:",chrome.runtime.lastError),e(!1)):(console.log("[content.js] Saved prompt to storage:",t),e(!0))}))})));case 1:e.n=3;break;case 2:e.p=2,r=e.v,console.error("Error saving to Chrome storage:",r);case 3:return e.a(2,!1)}}),e,null,[[0,2]])})))).apply(this,arguments)}function P(e){var t=e.tagName,n=e.isContentEditable,o=e.getAttribute("role");return"INPUT"===t&&!["button","submit","reset","checkbox","radio","file","image"].includes(e.type)||"TEXTAREA"===t||(n?"main"!==e.id&&"search"!==e.getAttribute("data-tab"):"DIV"===t&&"textbox"===o&&"10"===e.getAttribute("data-tab"))}null!==(e=chrome)&&void 0!==e&&null!==(e=e.storage)&&void 0!==e&&e.onChanged&&chrome.storage.onChanged.addListener((function(e,t){if("sync"===t&&e.savedPrompt){var n=e.savedPrompt.newValue||"";console.log("[content.js] Storage changed from another tab:",n),w=n,window.__lastPopupPrompt=n}})),E(),chrome.runtime.onMessage.addListener((function(e,t,n){if(e&&"PING"===e.type)return n({ok:!0}),!0})),console.log("%c🔍 Gemini Text Enhancer content script loaded!","background: #4CAF50; color: white; padding: 5px; border-radius: 3px; font-size: 14px;");var A=document.createElement("div");A.style.cssText="\n    position: fixed;\n    bottom: 10px;\n    right: 10px;\n    background: #4CAF50;\n    color: white;\n    padding: 5px 10px;\n    border-radius: 3px;\n    font-size: 12px;\n    z-index: 999999;\n    opacity: 0.8;\n",A.textContent="Gemini Enhancer Active",document.body.appendChild(A);var k=function(e){if(console.log("%c🔍 getInputText called for:","color: #2196F3",e),!e)return console.error("%cgetInputText received null/undefined element.","color: #F44336"),"";if("INPUT"===e.tagName||"TEXTAREA"===e.tagName)return e.value||"";if(e.isContentEditable){var t=e.querySelectorAll('[data-lexical-text="true"]');if(t.length>0){var n=Array.from(t).map((function(e){return e.textContent||""})).join("");return console.log("%cCombined text from spans:","color: #2196F3",'"'.concat(n,'"')),n}return e.textContent||""}return""};function S(e,t){return M.apply(this,arguments)}function M(){return(M=c(n().m((function e(t,o){var r,a,l,s,f,m,h,v,x,w,E,C,F,T,P,A,S,M,N;return n().w((function(e){for(;;)switch(e.n){case 0:if(t){e.n=1;break}return e.a(2);case 1:if(console.log("%c🔧 setInputText called with text:","color: #FF5722",o),console.log("%c🔧 Target element:","color: #FF5722",t),t.focus(),p=!0,"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName){e.n=4;break}return e.p=2,t.value=o,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.setSelectionRange(o.length,o.length),console.log("%c🔧 Standard input/textarea updated successfully","color: #4CAF50"),g=o,d=o,p=!1,e.a(2);case 3:e.p=3,A=e.v,console.log("%c🔧 Standard input method failed:","color: #F44336",A);case 4:r=t.closest('div[contenteditable="true"]')||t,a=!1,e.p=5,console.log("%c🔧 Method 1: Aggressive clearing and replacement","color: #2196F3"),r.focus(),l=0;case 6:if(!(l<3)){e.n=9;break}console.log("%c🔧 Clearing attempt ".concat(l+1),"color: #FF9800");try{s=window.getSelection(),(f=document.createRange()).selectNodeContents(r),s.removeAllRanges(),s.addRange(f),f.deleteContents(),document.execCommand("delete"),document.execCommand("cut"),s.removeAllRanges()}catch(e){console.log("Clear attempt ".concat(l+1," failed:"),e)}try{for(r.innerHTML="",r.textContent="";r.firstChild;)r.removeChild(r.firstChild)}catch(e){console.log("DOM clear attempt ".concat(l+1," failed:"),e)}if(m=r.textContent||r.innerText||"",console.log("%c🔧 After clear attempt ".concat(l+1,", remaining text:"),"color: #FF9800",'"'.concat(m,'"')),m.trim()){e.n=7;break}return console.log("%c🔧 Successfully cleared content","color: #4CAF50"),e.a(3,9);case 7:return e.n=8,new Promise((function(e){return setTimeout(e,50)}));case 8:l++,e.n=6;break;case 9:"true"===r.dataset.lexicalEditor?((h=document.createElement("p")).className="selectable-text copyable-text",(v=document.createElement("span")).setAttribute("data-lexical-text","true"),v.textContent=o,h.appendChild(v),r.appendChild(h)):r.textContent=o,a=!0,console.log("%c🔧 Method 1: SUCCESS","color: #4CAF50"),e.n=11;break;case 10:e.p=10,S=e.v,console.log("%c🔧 Method 1 failed:","color: #F44336",S);case 11:if(a){e.n=15;break}return e.p=12,console.log("%c🔧 Method 2: Keyboard simulation","color: #2196F3"),r.focus(),r.dispatchEvent(new KeyboardEvent("keydown",{key:"a",code:"KeyA",ctrlKey:!0,bubbles:!0})),e.n=13,new Promise((function(e){return setTimeout(e,50)}));case 13:x=i(o);try{for(x.s();!(w=x.n()).done;)E=w.value,r.dispatchEvent(new KeyboardEvent("keydown",{key:E,code:"Key".concat(E.toUpperCase()),bubbles:!0})),r.dispatchEvent(new InputEvent("input",{data:E,inputType:"insertText",bubbles:!0}))}catch(e){x.e(e)}finally{x.f()}a=!0,console.log("%c🔧 Method 2: SUCCESS","color: #4CAF50"),e.n=15;break;case 14:e.p=14,M=e.v,console.log("%c🔧 Method 2 failed:","color: #F44336",M);case 15:if(!a)try{console.log("%c🔧 Method 3: Force innerHTML replacement","color: #2196F3"),C=o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),"true"===r.dataset.lexicalEditor?r.innerHTML='<p class="selectable-text copyable-text"><span data-lexical-text="true">'.concat(C,"</span></p>"):r.innerHTML=C,a=!0,console.log("%c🔧 Method 3: SUCCESS","color: #4CAF50")}catch(e){console.log("%c🔧 Method 3 failed:","color: #F44336",e)}if(a||"true"!==r.dataset.lexicalEditor){e.n=20;break}if(e.p=16,console.log("%c🔧 Method 4: Lexical editor specific approach","color: #2196F3"),!(F=b(r))){e.n=18;break}return e.n=17,y(F,o);case 17:e.v&&(a=!0,console.log("%c🔧 Method 4: SUCCESS via Lexical editor","color: #4CAF50"));case 18:e.n=20;break;case 19:e.p=19,N=e.v,console.log("%c🔧 Method 4 failed:","color: #F44336",N);case 20:try{T=document.createRange(),P=window.getSelection(),T.selectNodeContents(r),T.collapse(!1),P.removeAllRanges(),P.addRange(T)}catch(e){console.log("%c🔧 Cursor positioning failed:","color: #FFC107",e)}[new Event("input",{bubbles:!0}),new Event("change",{bubbles:!0}),new KeyboardEvent("keyup",{bubbles:!0})].forEach((function(e){try{r.dispatchEvent(e)}catch(e){console.log("%c🔧 Event dispatch failed:","color: #FFC107",e)}})),g=o,d=o,setTimeout(c(n().m((function e(){var t,c,a,i,l;return n().w((function(e){for(;;)switch(e.n){case 0:if(t=k(r),console.log("%c🔧 Final verification - Expected:","color: #2196F3",'"'.concat(o,'"')),console.log("%c🔧 Final verification - Actual:","color: #2196F3",'"'.concat(t,'"')),t.includes("hi i is shivam")||t!==o){console.log("%c🔧 Verification failed, attempting final cleanup","color: #FF9800");try{c=r.parentElement,a=r.cloneNode(!1),"true"===r.dataset.lexicalEditor?((i=document.createElement("p")).className="selectable-text copyable-text",(l=document.createElement("span")).setAttribute("data-lexical-text","true"),l.textContent=o,i.appendChild(l),a.appendChild(i)):a.textContent=o,c.replaceChild(a,r),a.focus(),u===r&&(u=a),console.log("%c🔧 Final cleanup completed","color: #4CAF50")}catch(e){console.log("%c🔧 Final cleanup failed:","color: #F44336",e)}}p=!1;case 1:return e.a(2)}}),e)}))),200);case 21:return e.a(2)}}),e,null,[[16,19],[12,14],[5,10],[2,3]])})))).apply(this,arguments)}var N=function(e,t){if(!e||!e.offsetParent)return console.log("%cElement not visible or invalid for popup.","color: #FFC107"),void j();h=t,console.log("%cText stored for enhancement:","color: #4CAF50",'"'.concat(h,'"'),"Time: ".concat(performance.now().toFixed(2),"ms"));var n=e.getBoundingClientRect(),o=n.left+window.scrollX,r=n.bottom+window.scrollY+5;o+200>window.innerWidth&&(o=window.innerWidth-200-10),r+50>window.innerHeight&&(r=n.top+window.scrollY-50-5),R.style.left="".concat(o,"px"),R.style.top="".concat(r,"px"),R.style.display="block",R.offsetHeight,R.style.opacity="1",console.log("Popup shown for:",e.tagName,"at","(".concat(o,", ").concat(r,")"),"Time: ".concat(performance.now().toFixed(2),"ms"))},O=function(){var e=c(n().m((function e(o){var r,c,a,i,l,s,u,d=arguments;return n().w((function(e){for(;;)switch(e.n){case 0:if(r=d.length>1&&void 0!==d[1]&&d[1],t){e.n=1;break}return console.error("Gemini API key is not set."),r||alert("Gemini API key is not set. Please check your config.js"),e.a(2,null);case 1:return c=/source text:|translate to|translate into|translate|option 1:|fix any grammatical/i.test(o)||o.includes("{text}"),"",a=c?o:"Fix any grammatical errors and improve this text to be more professional, but keep it concise and only give option one: ".concat(o),e.p=2,e.n=3,L(a,r);case 3:if(!((i=e.v)&&i.candidates&&i.candidates.length>0)){e.n=4;break}return l=i.candidates[0].content.parts[0].text,s=l.match(/Option 1:\s*(.*)/i),e.a(2,s?s[1].trim():l.trim());case 4:return console.warn("Gemini API response did not contain candidates.",i),r||alert("Could not get enhanced text from Gemini API. No candidates found."),e.a(2,null);case 5:e.n=7;break;case 6:return e.p=6,u=e.v,console.error("Error enhancing text with Gemini API:",u),r||alert("Error enhancing text: ".concat(u.message,". Check console for details.")),e.a(2,null);case 7:return e.a(2)}}),e,null,[[2,6]])})));return function(t){return e.apply(this,arguments)}}();function I(e){if("TEXTAREA"===e.tagName||"INPUT"===e.tagName)e.focus(),e.setSelectionRange(e.value.length,e.value.length);else if(e.isContentEditable){var t=document.createRange(),n=window.getSelection();t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t)}}var R=function(){var e=document.createElement("div");return e.id="gemini-enhancer-popup",e.style.cssText="\n        position: absolute;\n    ",document.body.appendChild(e),e}();function j(){R.innerHTML="";var e=document.createElement("button");e.textContent="Enhance",e.style.cssText="\n        padding: 6px 12px;\n        border-radius: 6px;\n        border: none;\n        background: #4CAF50;\n        color: white;\n        cursor: pointer;\n        font-size: 14px;\n    ",e.addEventListener("click",function(e){return function(){var t=c(n().m((function t(o){var r,c,a,i,l;return n().w((function(t){for(;;)switch(t.n){case 0:if(o.preventDefault(),o.stopPropagation(),u&&h){t.n=1;break}return console.warn("No active input or no text to enhance."),t.a(2);case 1:return e.disabled=!0,e.textContent="Enhancing...",r=function(e){if("Enter"===e.key)return e.preventDefault(),e.stopImmediatePropagation(),!1},document.addEventListener("keydown",r,!0),document.addEventListener("keyup",r,!0),t.p=2,t.n=3,E();case 3:return(c=t.v)||(c=w||window.__lastPopupPrompt||""),console.log("[content.js] Using prompt for enhancement:",c),"",a=c&&c.includes("{text}")?c.replaceAll("{text}",h):c&&/translate|hindi|convert|change the text|translate to|translate into/i.test(c)||c?h?"".concat(c,"\n\nSource text:\n").concat(h):c:"Fix any grammatical errors and improve this text to be more professional, but keep it concise and only give option one: ".concat(h),console.log("%c🤖 Calling Gemini API with finalPrompt (enhance button):","color: #8D6E63","".concat(a)),t.n=4,O(a+v,!0);case 4:if(!(i=t.v)){t.n=6;break}return console.log("✨ Enhanced text received:",i),t.n=5,S(u,i);case 5:I(u),g=i,console.log("%clastEnhancedText updated to:","color: #FFC107","".concat(g),"Time:",performance.now().toFixed(2)+"ms"),t.n=7;break;case 6:console.error("Failed to get enhanced text from API");case 7:t.n=9;break;case 8:t.p=8,l=t.v,console.error("Error during text enhancement:",l);case 9:setTimeout((function(){document.removeEventListener("keydown",r,!0),document.removeEventListener("keyup",r,!0)}),1500),e.disabled=!1,e.textContent="Enhance",j();case 10:return t.a(2)}}),t,null,[[2,8]])})));return function(e){return t.apply(this,arguments)}}()}(e)),R.appendChild(e),R.style.opacity="0",R.style.display="none",s&&clearTimeout(s),m&&clearTimeout(m)}function L(e){return _.apply(this,arguments)}function _(){return _=c(n().m((function e(o){var r,c,a,i,l,s,u=arguments;return n().w((function(e){for(;;)switch(e.n){case 0:return r=u.length>1&&void 0!==u[1]&&u[1],c={contents:[{parts:[{text:o}]}]},e.p=1,e.n=2,fetch("".concat("https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent","?key=").concat(t),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});case 2:if(a=e.v,console.log("API Response Status:",a.status),console.log("API Response Status Text:",a.statusText),a.ok){e.n=4;break}return e.n=3,a.json();case 3:throw i=e.v,console.error("API Error Response:",i),new Error("API request failed: ".concat(a.status,"  - ").concat(i.error.message));case 4:return e.n=5,a.json();case 5:return l=e.v,e.a(2,l);case 6:throw e.p=6,s=e.v,console.error("%c❌ Error calling Gemini API:","color: #F44336",s),r||alert("Error calling Gemini API: ".concat(s.message,". Check console for details.")),s;case 7:return e.a(2)}}),e,null,[[1,6]])}))),_.apply(this,arguments)}document.addEventListener("focusin",(function(e){var t,n=e.target;if(P(n))u=n,console.log("Focus event detected on element:",n.tagName,", contentEditable:",n.isContentEditable),console.log("Setting lastActiveInput to:",u),s&&(clearTimeout(s),s=null),R.style.display="none",j(),t=n,f&&(f.disconnect(),console.log("%cDisconnecting previous MutationObserver.","color: #FFC107")),console.log("%cSetting up MutationObserver for contenteditable element:","color: #FFC107",t),(f=new MutationObserver((function(e){if(p)console.log("%cSkipping mutation processing during API update.","color: #FFC107");else{console.log("%c🌳 MutationObserver callback triggered.","color: #4CAF50","Time: ".concat(performance.now().toFixed(2),"ms"));var n=k(t),o=n.trim(),r=d.trim(),c=g.trim();console.log("%c[MutationObserver] Current text (trimmed): ","color: #4CAF50",'"'.concat(o,'"')),console.log("%c[MutationObserver] Last processed text (trimmed): ","color: #4CAF50",'"'.concat(r,'"')),console.log("%c[MutationObserver] Last enhanced text (trimmed): ","color: #4CAF50",'"'.concat(c,'"')),console.log("%c[MutationObserver] current === lastEnhanced: ","color: #4CAF50",o===c),console.log("%c[MutationObserver] current === lastProcessed: ","color: #4CAF50",o===r),o!==c&&o!==r?(o!==r&&o&&(console.log("%c[MutationObserver] Text changed and is not empty/whitespace, scheduling new timeout for popup (2000ms).","color: #4CAF50"),m&&clearTimeout(m),m=setTimeout((function(){console.log("%c[MutationObserver] Timeout triggered! Attempting to show popup.","color: #4CAF50");var e=k(t),n=e.trim();n&&n!==c?(console.log("%c[MutationObserver] Text is genuinely new after delay, showing popup.","color: #4CAF50"),N(t,e)):console.log("%c[MutationObserver] Text is empty, whitespace, or matches last enhanced text at timeout, not showing popup.","color: #FFC107")}),2e3),d=n,console.log("%c[MutationObserver] lastProcessedText updated to:","color: #FFC107",'"'.concat(d,'"'))),console.log("%cisApiUpdate after mutation processing:","color: #FFC107",p)):console.log("Text matches last enhanced/processed text, not showing popup.")}}))).observe(t,{childList:!0,subtree:!0,characterData:!0}),d=k(n);else{if(function(e){var t,n=(null===(t=e.getAttribute("aria-label"))||void 0===t?void 0:t.toLowerCase())||"";return n.includes("search")||n.includes("search input")}(n))return void console.log("Ignoring search box focus");console.log("Focus event detected on element (ignored as not valid input): ",n.tagName,", contentEditable:",n.isContentEditable)}})),document.addEventListener("input",(function(e){if(console.log("%c⌨️ Input event detected:","color: #FF9800",e.target.tagName,"Time: ".concat(performance.now().toFixed(2),"ms")),p)console.log("%cInput event is from API update, not showing popup.","color: #FFC107");else{var t=e.target;if(t&&P(t)){var n=k(t),o=n.trim(),r=d.trim(),c=g.trim();console.log("Current text from getInputText:",'"'.concat(n,'"')),console.log("Current text (trimmed): ",'"'.concat(o,'"')),console.log("Last processed text (trimmed): ",'"'.concat(r,'"')),console.log("Last enhanced text (trimmed): ",'"'.concat(c,'"')),console.log("current === lastEnhanced: ",o===c),console.log("current === lastProcessed: ",o===r),o!==c&&o!==r?o!==r&&(console.log("Text changed from last processed, scheduling popup timer."),s&&clearTimeout(s),s=setTimeout((function(){u&&u===t&&(console.log("Timeout triggered! Showing popup for element:",t,"Time: ".concat(performance.now().toFixed(2),"ms")),N(t,n))}),2e3),d=n,console.log("%clastProcessedText updated to:","color: #FFC107",'"'.concat(d,'"'))):console.log("Text matches last enhanced/processed text, not showing popup.")}}})),chrome.runtime.onMessage.addListener((function(e,t,o){if(e&&"PING"===e.type)return o({ok:!0}),!0;if(e&&"PROMPT_FROM_POPUP"===e.type){var r="string"==typeof e.prompt?e.prompt:String(e.prompt||"");return console.log("[content.js] Received PROMPT_FROM_POPUP:",r,"from",t),c(n().m((function e(){var t,c,a,i,l,s,d,p,f;return n().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,F(r);case 1:w=r,window.__lastPopupPrompt=r;try{chrome.runtime.sendMessage({type:"PROMPT_UPDATED",prompt:r})}catch(e){}if("function"!=typeof O){e.n=11;break}if(t=null,e.p=2,c=r.trim(),a="",void 0!==u&&u)try{a=k(u)}catch(e){a=""}return a||"string"!=typeof h||(a=h),"",i=c.includes("{text}")?c.replaceAll("{text}",a||""):/translate|hindi|convert|change the text|translate to|translate into/i.test(c)||c.length>0?a?"".concat(c,"\n\nSource text:\n").concat(a):c:"Fix any grammatical errors and improve this text to be more professional, but keep it concise and only give option one: ".concat(a),console.log("[content.js] Final prompt constructed:",i),e.n=3,O(i+v,!0);case 3:t=e.v,e.n=6;break;case 4:return e.p=4,p=e.v,console.error("[content.js] Error while building finalPrompt:",p),e.n=5,O(r+v,!0);case 5:t=e.v;case 6:if(console.log("[content.js] Enhanced prompt:",t),void 0===u||!u||!P(u)){e.n=10;break}return e.n=7,S(u,t||r);case 7:e.n=9;break;case 8:u.isContentEditable?(u.innerText=t||r,u.dispatchEvent(new Event("input",{bubbles:!0}))):(u.value=t||r,u.dispatchEvent(new Event("input",{bubbles:!0})));case 9:return I(u),g=t||r,o({success:!0,injected:!0,enhanced:!!t}),e.a(2);case 10:return w=t||r,window.__lastPopupPrompt=t||r,g=t||r,o({success:!0,injected:!1,enhanced:!!t}),e.a(2);case 11:if(!(l=document.activeElement)||"INPUT"!==l.tagName&&"TEXTAREA"!==l.tagName&&!l.isContentEditable){e.n=12;break}return l.isContentEditable?(l.innerText=r,(s=document.createRange()).selectNodeContents(l),s.collapse(!1),(d=window.getSelection()).removeAllRanges(),d.addRange(s)):(l.value=r,l.dispatchEvent(new Event("input",{bubbles:!0}))),o({success:!0,injected:!0,enhanced:!1}),e.a(2);case 12:w=r,window.__lastPopupPrompt=r,o({success:!0,injected:!1,enhanced:!1}),e.n=14;break;case 13:e.p=13,f=e.v,console.error("[content.js] Error processing prompt:",f),o({success:!1,error:f&&f.message?f.message:String(f)});case 14:return e.a(2)}}),e,null,[[2,4],[0,13]])})))(),!0}})),chrome.runtime.onMessage.addListener((function(e,t,n){e&&"PROMPT_UPDATED"===e.type&&(console.log("[content.js] Received prompt update from another tab:",e.prompt),w=e.prompt,window.__lastPopupPrompt=e.prompt,n({received:!0}))}))})();